service: NersaryMailReactor
frameworkVersion: '3'

provider:
  name: aws
  region: ap-northeast-1
  runtime: nodejs16.x
  endpointType: regional
  logRetentionInDays: 7
  deploymentBucket:
    blockPublicAccess: true
    serverSideEncryption: AES256
  environment:
    SERVICE: ${self:service}
    SLACK_BOT_USER_OAUTH_TOKEN: ${env:SLACK_BOT_USER_OAUTH_TOKEN}
  iam:
    role:
      managedPolicies:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaRole
  ecr:
    images:
      browser:
        path: .
        file: docker/browser/Dockerfile

functions:
  Reactor:
    handler: src/reactor.handler
    timeout: 5
    url:
      cors: true
    environment:
      OPENBOT_FUNCTION: !Ref OpenBotLambdaFunction
  OpenBot:
    timeout: 15
    memorySize: 1024
    image:
      name: browser
      command: ['src/openbot.handler']
  Attachment:
    handler: src/attachment.handler
    timeout: 5
    url:
      cors: true
    environment:
      ATTACHMENTBOT_FUNCTION: !Ref AttachmentBotLambdaFunction
  AttachmentBot:
    timeout: 30
    memorySize: 1024
    image:
      name: browser
      command: ['src/attachmentbot.handler']

package:
  patterns:
    - 'node_modules/**'
    - 'src/**'
    - '!dist/**'
    - 'package.json'
    - 'yarn.lock'
    - '!serverless.yml'
